{% extends 'core/citizen_base.html' %}

{% block title %}Request Completed - {{ citizen_request.case_code }}{% endblock %}

{% block citizen_block %}
<div class="flex justify-center mt-2">
    <div class="w-full max-w-xl px-4 sm:px-0">

        <div class="bg-white p-8 border border-gray-200 rounded-xl shadow-lg mb-6 text-center">
            <div class="inline-flex h-16 w-16 rounded-full
                {% if citizen_request.status == 'RESOLVED' %}bg-green-100
                {% elif citizen_request.status == 'IN_PROGRESS' %}bg-yellow-100
                {% elif citizen_request.status == 'ASSIGNED' %}bg-blue-100
                {% else %}bg-gray-100{% endif %}
                items-center justify-center mb-4">
                <i class="bi
                    {% if citizen_request.status == 'RESOLVED' %}bi-check-circle-fill text-4xl text-green-600
                    {% elif citizen_request.status == 'IN_PROGRESS' %}bi-clock-fill text-4xl text-yellow-600
                    {% elif citizen_request.status == 'ASSIGNED' %}bi-person-check-fill text-4xl text-blue-600
                    {% else %}bi-hourglass-split text-4xl text-gray-600{% endif %}
                    p-0 m-0"></i>
            </div>

            <h1 class="text-2xl font-bold text-gray-800 mb-1">
                {% if citizen_request.status == 'RESOLVED' %}Request Completed
                {% elif citizen_request.status == 'IN_PROGRESS' %}Request In Progress
                {% elif citizen_request.status == 'ASSIGNED' %}Request Assigned
                {% else %}Request Submitted{% endif %}
            </h1>

            <p class="text-base font-medium text-gray-700 mb-2">
                Case #: <span class="font-bold text-gray-900">{{ citizen_request.case_code }}</span>
            </p>

            <p class="text-sm text-gray-500">
                Submitted on {{ citizen_request.created_at|date:"F j, Y" }} at {{ citizen_request.created_at|time:"g:i A" }}
            </p>
        </div>

        <!-- Request Details -->
        <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-lg mb-6">
            <div class="flex items-center space-x-3 mb-4">
                <i class="bi bi-info-circle-fill text-xl text-blue-600"></i>
                <h2 class="text-lg font-semibold text-gray-800">
                    Request Details
                </h2>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500 font-medium">Category:</span>
                    <span class="text-gray-700 font-semibold">{{ citizen_request.get_category_display|default:"Not specified" }}</span>
                </div>

                <div class="flex justify-between text-sm">
                    <span class="text-gray-500 font-medium">Urgency Level:</span>
                    <span class="text-gray-700 font-semibold">{{ citizen_request.get_urgency_level_display|default:"Not specified" }}</span>
                </div>

                <div class="flex justify-between text-sm">
                    <span class="text-gray-500 font-medium">Assigned To:</span>
                    <span class="text-gray-700 font-semibold">
                        {% if citizen_request.assigned_department %}
                            {{ citizen_request.assigned_department.name }}
                        {% else %}
                            Not assigned yet
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-700">{{ citizen_request.request_text }}</p>
            </div>
        </div>

        {% if latest_appointment %}
        <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-lg mb-6">

            <div class="flex items-center space-x-3">
                <i class="bi bi-calendar-check-fill text-xl text-blue-600"></i>
                <h2 class="text-lg font-semibold text-gray-800">
                    Appointment Booked
                </h2>
            </div>

            <div class="border-gray-100 mb-3 ml-8 mt-1">
                <p class="text-sm text-gray-500 font-medium">
                    {{ latest_appointment.scheduled_at|date:"l, F j" }} at {{ latest_appointment.scheduled_at|time:"g:i A" }}
                </p>
            </div>
            <hr class="py-3"/>

            <div class="space-y-2">
                {% if latest_appointment.entity %}
                <div class="flex items-start text-gray-700 text-sm">
                    <i class="bi bi-geo-alt-fill text-base mr-3 w-5 text-gray-400 flex-shrink-0 mt-0.5"></i>
                    <p>
                        {{ latest_appointment.entity.name }}
                    </p>
                </div>
                {% endif %}

                {% if latest_appointment.location_details %}
                <div class="flex items-start text-gray-700 text-sm">
                    <i class="bi bi-geo-fill text-base mr-3 w-5 text-gray-400 flex-shrink-0 mt-0.5"></i>
                    <p>
                        {{ latest_appointment.location_details }}
                    </p>
                </div>
                {% endif %}

                {% if latest_appointment.entity.phone %}
                <div class="flex items-start text-gray-700 text-sm">
                    <i class="bi bi-telephone-fill text-base mr-3 w-5 text-gray-400 flex-shrink-0 mt-0.5"></i>
                    <p>
                        {{ latest_appointment.entity.phone }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Actions Taken -->
        <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-lg mb-6">
            <div class="flex items-center space-x-3 pb-3 border-b border-gray-100 mb-4">
                <i class="bi bi-graph-up text-xl text-blue-600"></i>
                <h2 class="text-lg font-semibold text-gray-800">
                    Actions Taken ({{ actions.count }})
                </h2>
            </div>

            <div class="space-y-4">
                {% if actions %}
                    {% for action in actions %}
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center">
                            <i class="bi
                                {% if action.success %}bi-check-circle-fill text-lg text-green-500
                                {% else %}bi-x-circle-fill text-lg text-red-500{% endif %}
                                mr-3 flex-shrink-0"></i>
                            <div>
                                <p class="text-gray-700 font-medium">{{ action.get_action_type_display }}</p>
                                <p class="text-gray-500 text-xs">{{ action.description }}</p>
                            </div>
                        </div>
                        <span class="text-xs text-gray-500 ml-4 flex-shrink-0">
                            {{ action.created_at|time:"H:i" }}
                        </span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clock-history text-2xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500 text-sm">No actions taken yet</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Emergency Calls -->
        {% if emergency_calls %}
        <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-lg mb-6">
            <div class="flex items-center space-x-3 pb-3 border-b border-gray-100 mb-4">
                <i class="bi bi-telephone-outbound-fill text-xl text-red-600"></i>
                <h2 class="text-lg font-semibold text-gray-800">
                    Emergency Calls
                </h2>
            </div>

            <div class="space-y-3">
                {% for call in emergency_calls %}
                <div class="flex justify-between items-center text-sm p-3 bg-red-50 rounded-lg">
                    <div class="flex items-center">
                        <i class="bi bi-telephone-fill text-base text-red-500 mr-3"></i>
                        <div>
                            <p class="text-gray-700 font-medium">Called {{ call.department.name }}</p>
                            <p class="text-gray-500 text-xs">{{ call.phone_number }}</p>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500">{{ call.initiated_at|time:"H:i" }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Important Information -->
        <div class="bg-yellow-50 mt-6 p-4 rounded-xl border border-yellow-200 shadow-md mb-8">
            <div class="flex items-start mb-2">
                <i class="bi bi-exclamation-triangle-fill text-lg text-yellow-600 mr-2 mt-0.5"></i>
                <h3 class="text-base font-semibold text-yellow-800">
                    Important Information
                </h3>
            </div>
            <ul class="list-disc list-inside space-y-1 ml-5 text-yellow-800 text-sm">
                <li>Keep your case number ({{ citizen_request.case_code }}) handy</li>
                <li>Arrive 15 minutes before your scheduled time</li>
                <li>Bring relevant documents and identification</li>
                {% if citizen_request.category == 'HEALTH' %}
                <li>Bring medical history and current medications</li>
                {% elif citizen_request.category == 'POLICE' %}
                <li>Bring any evidence or documentation related to your case</li>
                {% endif %}
            </ul>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-4 mb-6">
            {% if citizen_request.target_location %}
            <button class="w-1/2 flex items-center justify-center px-4 py-3 rounded-xl font-semibold text-lg text-white bg-blue-600 hover:bg-blue-700 transition shadow-lg"
                    onclick="viewOnMap()">
                <i class="bi bi-cursor mr-2 text-lg"></i>
                View on Map
            </button>
            {% endif %}

            {% if latest_appointment and latest_appointment.entity.phone %}
            <a href="tel:{{ latest_appointment.entity.phone }}"
               class="w-1/2 flex items-center justify-center px-4 py-3 rounded-xl font-semibold text-lg text-white bg-green-600 hover:bg-green-700 transition shadow-lg">
                <i class="bi bi-telephone mr-2 text-xl"></i>
                Call {% if latest_appointment.entity %}{{ latest_appointment.entity.name }}{% else %}Department{% endif %}
            </a>
            {% endif %}
        </div>

        <!-- Secondary Buttons -->
        <div class="flex space-x-4 mb-10">
            <button class="w-1/2 flex items-center justify-center px-4 py-3 rounded-xl font-semibold text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 transition shadow-sm"
                    onclick="shareCase()">
                <i class="bi bi-share mr-2 text-xl"></i>
                Share
            </button>

            <a href="{% url 'my_emergency_requests' %}"
               class="w-1/2 flex items-center justify-center px-4 py-3 rounded-xl font-semibold text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 transition shadow-sm">
                <i class="bi bi-list-ul mr-2 text-xl"></i>
                All Requests
            </a>
        </div>

        <!-- Submit New Request -->
        <div class="text-center">
            <a href="{% url 'submit_emergency_request' %}"
               class="w-full py-4 rounded-xl font-semibold text-xl text-white bg-red-600 hover:bg-red-700 transition shadow-xl inline-block">
                Submit New Request
            </a>
        </div>
    </div>
</div>

{% endblock citizen_block %}

{% block extra_js %}
<script>
    function viewOnMap() {
        // Implement map viewing functionality
        alert('Map view would open here with location data');
    }

    function shareCase() {
        const caseCode = '{{ citizen_request.case_code }}';
        const shareText = `My emergency request case: ${caseCode}`;

        if (navigator.share) {
            navigator.share({
                title: 'Emergency Request Case',
                text: shareText,
                url: window.location.href
            });
        } else {
            // Fallback for browsers that don't support Web Share API
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Case details copied to clipboard!');
            });
        }
    }
</script>
{% endblock extra_js %}