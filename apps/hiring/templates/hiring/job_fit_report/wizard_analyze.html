{% extends "core/new_base.html" %}

{% block title %}Job Fit Analysis | Frontline Assistant AI{% endblock %}
{% block current_page %}Job Fit Analysis{% endblock %}
{% block page_title %}Create Job & Match Candidates{% endblock %}
{% block page_subtitle %}Follow the steps to create a job posting and find the best candidates{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
  {% if error %}
  <div class="mb-4 p-3 rounded-md bg-red-50 text-red-700 text-sm">{{ error }}</div>
  {% endif %}

  <!-- Step wizard header -->
  <div class="mt-6 flex justify-center">
    <div class="flex items-center">
      <div class="flex items-center">
        <div class="flex flex-col items-center">
          <div class="w-10 h-10 rounded-full border-2 border-orange-500 bg-orange-500 text-white flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
          </div>
          <div class="text-center mt-2">
            <p class="text-orange-500 font-medium text-sm">Job Details</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs max-w-24 mt-1">Basic job information</p>
          </div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500 dark:text-gray-400 -mt-8 mx-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </div>

      <div class="flex items-center">
        <div class="flex flex-col items-center">
          <div class="w-10 h-10 rounded-full border-2 border-orange-500 bg-orange-500 text-white flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
          </div>
          <div class="text-center mt-2">
            <p class="text-orange-500 font-medium text-sm">Upload Resumes</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs max-w-24 mt-1">Add candidate resumes</p>
          </div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500 dark:text-gray-400 -mt-8 mx-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </div>

      <div class="flex items-center">
        <div class="flex flex-col items-center">
          <div class="w-10 h-10 rounded-full border-2 border-orange-500 bg-gray-50 dark:bg-gray-800 text-orange-500 flex items-center justify-center">
            <span class="font-medium text-sm">3</span>
          </div>
          <div class="text-center mt-2">
            <p class="text-orange-500 font-medium text-sm">Match Candidates</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs max-w-24 mt-1">Generate job fit reports</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form method="post" class="mt-6">
    {% csrf_token %}
    <input type="hidden" name="job_id" id="selectedJobId" value="">

    <div class="grid md:grid-cols-2 gap-6">
      <div class="bg-orange-50 dark:bg-gray-800 border border-orange-200 dark:border-orange-400/30 rounded-xl">
        <div class="p-6">
          <div class="mb-4">
            <h3 class="text-2xl font-semibold leading-6 tracking-tight flex items-center gap-2 dark:text-white">Select Job <span class="text-gray-500 dark:text-gray-400 font-normal text-sm">(Choose one)</span></h3>
          </div>
          {% if jobs %}
          <div class="space-y-2 max-h-96 overflow-auto" id="jobSelectionContainer">
            {% for job in jobs %}
              <div class="p-3 rounded-lg border cursor-pointer transition-colors flex items-start gap-3 job-card hover:border-orange-400 border-gray-200 dark:border-gray-700" data-job-id="{{ job.id }}">
                <div class="min-w-0">
                  <div class="text-base font-medium truncate dark:text-white">{{ job.parsed_detailed.title|default:"Job" }}</div>
                  <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ job.parsed_detailed.company|default:"â€”" }}</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-3">{{ job.description|truncatechars:180 }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
          {% else %}
            <div class="text-sm text-gray-500 dark:text-gray-400">No jobs available. <a class="text-orange-600" href="{% url 'hiring:job_create' %}">Create one</a>.</div>
          {% endif %}
        </div>
      </div>

      <div class="bg-orange-50 dark:bg-gray-800 border border-orange-200 dark:border-orange-400/30 rounded-xl">
        <div class="p-6">
          <div class="mb-4">
            <h3 class="text-2xl font-semibold leading-6 tracking-tight flex items-center gap-2 dark:text-white">Select Resumes <span class="text-gray-500 dark:text-gray-400 font-normal text-sm">(Choose multiple)</span></h3>
          </div>
          {% if resumes %}
          <div class="space-y-2 max-h-96 overflow-auto" id="resumeSelectionContainer">
            {% for resume in resumes %}
              <div class="p-3 rounded-lg border cursor-pointer transition-colors flex items-center justify-between resume-card hover:border-orange-400 border-gray-200 dark:border-gray-700" data-resume-id="{{ resume.id }}">
                <div class="flex items-center gap-3">
                  <div class="min-w-0">
                    <div class="text-sm font-medium truncate dark:text-white">{{ resume.metadata.name|default:resume.file.name }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Uploaded {{ resume.created_at|date:"M d, Y" }}</div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          {% else %}
            <div class="text-sm text-gray-500 dark:text-gray-400">No resumes available. <a class="text-orange-600" href="{% url 'hiring:resumes_upload' %}">Upload some</a>.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="bg-orange-50 dark:bg-gray-800 border-2 border-orange-200 dark:border-gray-700 border-dashed rounded-xl mt-6">
      <div class="p-6 text-center">
        <h3 class="text-lg font-semibold mb-1 dark:text-white">Ready to Analyze?</h3>
        <p class="text-gray-600 dark:text-gray-400">Select a job and resumes to get started</p>
        <button type="submit" id="submitButton" class="mt-4 inline-flex items-center min-h-10 px-8 rounded-md bg-orange-500 text-white text-sm font-medium opacity-50 cursor-not-allowed" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>
          Generate Job Fit Reports
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </button>
      </div>
    </div>

    <div class="flex justify-between items-center pt-6">
      <a href="{% url 'hiring:resumes_upload' %}" class="h-9 px-4 rounded-md border border-gray-300 dark:border-gray-600 text-sm font-medium dark:text-gray-200">Previous</a>
      <button type="submit" id="bottomSubmitButton" class="h-9 px-4 rounded-md bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium">Generate Reports
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const jobCards = document.querySelectorAll('.job-card');
  const resumeCards = document.querySelectorAll('.resume-card');
  const selectedJobIdInput = document.getElementById('selectedJobId');
  const submitButton = document.getElementById('submitButton');
  const bottomSubmitButton = document.getElementById('bottomSubmitButton');

  // Store selected resume IDs
  const selectedResumeIds = new Set();

  // Job selection logic (single selection)
  jobCards.forEach(card => {
    card.addEventListener('click', function() {
      const jobId = this.getAttribute('data-job-id');

      // Remove selection from all job cards
      jobCards.forEach(c => {
        c.classList.remove('border-red-500', 'border-2');
        c.classList.add('border-gray-200');
      });

      // Add selection to clicked card
      this.classList.remove('border-gray-200');
      this.classList.add('border-orange-500', 'border-2');

      // Store selected job ID
      selectedJobIdInput.value = jobId;

      // Enable submit button if both job and at least one resume are selected
      updateSubmitButtonState();
    });
  });

  // Resume selection logic (multiple selection)
  resumeCards.forEach(card => {
    card.addEventListener('click', function() {
      const resumeId = this.getAttribute('data-resume-id');

      // Toggle selection
      if (selectedResumeIds.has(resumeId)) {
        // Deselect
        selectedResumeIds.delete(resumeId);
        this.classList.remove('border-orange-500', 'border-2');
        this.classList.add('border-gray-200');
      } else {
        // Select
        selectedResumeIds.add(resumeId);
        this.classList.remove('border-gray-200');
        this.classList.add('border-orange-500', 'border-2');
      }

      // Enable submit button if both job and at least one resume are selected
      updateSubmitButtonState();
    });
  });

  // Update submit button state based on selections
  function updateSubmitButtonState() {
    const isJobSelected = selectedJobIdInput.value !== '';
    const isResumeSelected = selectedResumeIds.size > 0;

    if (isJobSelected && isResumeSelected) {
      submitButton.disabled = false;
      submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
      bottomSubmitButton.disabled = false;
    } else {
      submitButton.disabled = true;
      submitButton.classList.add('opacity-50', 'cursor-not-allowed');
      bottomSubmitButton.disabled = true;
    }
  }

  // Form submission - add selected resume IDs to form data
  document.querySelector('form').addEventListener('submit', function(e) {
    // Add hidden inputs for each selected resume
    selectedResumeIds.forEach(resumeId => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'resume_ids';
      input.value = resumeId;
      this.appendChild(input);
    });
  });
});
</script>

<style>
.job-card, .resume-card {
  transition: all 0.2s ease;
}
</style>
{% endblock %}