{% extends "core/new_base.html" %}

{% block title %}Job Fit Report | Frontline Assistant AI{% endblock %}
{% block current_page %}Reports{% endblock %}
{% block page_title %}Job Fit Report{% endblock %}
{% block page_subtitle %}Detailed analysis of candidate fit for the job{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <div class="flex items-center gap-4">
    <a href="{% url 'hiring:job_fit_reports' %}">
      <button class="w-9 h-9 inline-flex items-center justify-center rounded-md border border-gray-300 dark:border-dark-border dark:hover:bg-dark-hover dark:text-dark-text">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
      </button>
    </a>
    <div>
      <h1 class="text-2xl font-semibold dark:text-dark-text">{{ application.resume.metadata.name|default:application.resume.file.name }}</h1>
      <p class="text-gray-500 text-sm mt-1 dark:text-gray-400">Applied for {{ application.job.parsed_detailed.title|default:"Job" }} • {{ application.applied_at|date:"M j, Y" }}</p>
    </div>
    {% if application.status|lower == 'failed' %}
      <span class="ml-auto px-2 py-1 text-xs font-semibold rounded border border-red-300 text-red-700 bg-red-100 dark:bg-red-900 dark:text-red-300 dark:border-red-700">Failed</span>
    {% elif report %}
      <span class="ml-auto px-2 py-1 text-xs font-semibold rounded border border-green-300 text-green-700 bg-green-100 dark:bg-green-900 dark:text-green-300 dark:border-green-700">Completed</span>
    {% else %}
      <span class="ml-auto px-2 py-1 text-xs font-semibold rounded border border-orange-300 text-orange-700 bg-orange-100 dark:bg-orange-900 dark:text-orange-300 dark:border-orange-700">Processing</span>
    {% endif %}
  </div>

  {% if application.job_fit_report %}
  {% with report=application.job_fit_report %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
    <div class="lg:col-span-2 space-y-8">
      <!-- Executive Summary -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-dark-text">Hiring Recommendation</h2>
            <div class="text-right">
              <div class="text-3xl font-bold text-brand-primary">{{ report.overall_fit_score|floatformat:1 }}%</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Overall Fit Score</div>
            </div>
          </div>

          <div class="mb-6">
            <div class="w-full h-3 bg-gray-200 dark:bg-dark-border rounded-full overflow-hidden">
              <div class="h-3 bg-brand-primary" style="width: {{ report.overall_fit_score }}%"></div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center">
              <div class="text-lg font-semibold text-gray-900 dark:text-dark-text">{{ report.hiring_recommendation }}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Recommendation</div>
            </div>
            <div class="text-center">
              <div class="text-lg font-semibold text-gray-900 dark:text-dark-text">{{ report.confidence_level|title }}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Confidence Level</div>
            </div>
            <div class="text-center">
              <div class="text-lg font-semibold text-gray-900 dark:text-dark-text">{{ report.fit_category }}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Fit Category</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Eligibility Status -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-8">
          <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-6">Eligibility Status</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="text-center">
              <div class="text-2xl font-bold text-brand-primary">{{ report.eligibility_assessment.gates_passed }}/{{ report.eligibility_assessment.gates_evaluated }}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Requirements Met</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold {% if report.eligibility_assessment.overall_eligible %}text-green-600{% else %}text-red-600{% endif %}">
                {% if report.eligibility_assessment.overall_eligible %}✓{% else %}✗{% endif %}
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Eligible</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-900 dark:text-dark-text">{{ report.eligibility_assessment.gates_failed }}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Failed Requirements</div>
            </div>
          </div>

          <p class="text-gray-600 dark:text-dark-text text-center">{{ report.eligibility_assessment.eligibility_summary }}</p>
        </div>
      </div>

      <!-- Key Assessment Areas -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-8">
          <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-6">Key Assessment Areas</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for section in report.section_scores %}
              <div class="border border-gray-200 dark:border-dark-border rounded-lg p-6 bg-gray-50 dark:bg-dark-hover">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-text">{{ section.section_name|title }}</h3>
                  <div class="text-right">
                    <div class="text-2xl font-bold text-brand-primary">{{ section.raw_score|floatformat:1 }}%</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Score</div>
                  </div>
                </div>

                <div class="w-full h-2 bg-gray-200 dark:bg-dark-border rounded-full overflow-hidden mb-4">
                  <div class="h-2 bg-brand-primary" style="width: {{ section.raw_score }}%"></div>
                </div>

                {% if section.strengths %}
                <div class="mb-3">
                  <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Strengths</h4>
                  <div class="flex flex-wrap gap-1">
                    {% for strength in section.strengths|slice:":3" %}
                      <span class="px-2 py-1 text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded">{{ strength }}</span>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}

                {% if section.gaps %}
                <div>
                  <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Areas for Improvement</h4>
                  <div class="flex flex-wrap gap-1">
                    {% for gap in section.gaps|slice:":2" %}
                      <span class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded">{{ gap }}</span>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Key Insights -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-8">
          <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-6">Key Insights</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {% if report.top_strengths %}
            <div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-text mb-4">Top Strengths</h3>
              <div class="space-y-2">
                {% for strength in report.top_strengths|slice:":5" %}
                  <div class="flex items-center">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                    <span class="text-gray-700 dark:text-gray-300">{{ strength }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            {% if report.critical_gaps %}
            <div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-text mb-4">Areas of Concern</h3>
              <div class="space-y-2">
                {% for gap in report.critical_gaps|slice:":5" %}
                  <div class="flex items-center">
                    <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                    <span class="text-gray-700 dark:text-gray-300">{{ gap }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>

          {% if report.recommendations %}
          <div class="mt-8">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recommendations</h3>
            <div class="space-y-2">
              {% for rec in report.recommendations %}
                <div class="flex items-start">
                  <div class="w-2 h-2 bg-brand-primary rounded-full mr-3 mt-2"></div>
                  <span class="text-gray-700 dark:text-gray-300">{{ rec }}</span>
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Skills Summary -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-8">
          <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-6">Skills Assessment</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="text-center">
              <div class="text-2xl font-bold text-brand-primary">{{ report.skills_score.raw_score|floatformat:1 }}%</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Overall Skills Score</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ report.skills_score.details.required_skills.matched }}/{{ report.skills_score.details.required_skills.total }}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Required Skills Met</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ report.skills_score.details.preferred_skills.matched }}/{{ report.skills_score.details.preferred_skills.total }}</div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Preferred Skills Met</div>
            </div>
          </div>

          <div class="w-full h-2 bg-gray-200 dark:bg-dark-border rounded-full overflow-hidden">
            <div class="h-2 bg-brand-primary" style="width: {{ report.skills_score.raw_score }}%"></div>
          </div>
        </div>
      </div>


    </div>

    <!-- Right Sidebar -->
    <div class="space-y-8">
      <!-- Candidate Info -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-text mb-4">Candidate Information</h3>
          <div class="space-y-3">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Name</p>
              <p class="font-medium text-gray-900 dark:text-dark-text">{{ application.resume.metadata.personal_info.full_name|default:application.resume.file.name }}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Email</p>
              <p class="font-medium text-gray-900 dark:text-dark-text">{{ application.resume.metadata.contact_info.email|default:"—" }}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Phone</p>
              <p class="font-medium text-gray-900 dark:text-dark-text">{{ application.resume.metadata.contact_info.phone|default:"—" }}</p>
            </div>
          </div>

          <div class="mt-6 flex gap-3">
            <a href="{{ application.resume.file.url }}" class="flex-1 bg-brand-primary text-white px-4 py-2 rounded-lg text-sm font-medium text-center hover:bg-orange-600 transition-colors" download>
              Download Resume
            </a>
            <a href="mailto:{{ application.resume.metadata.contact_info.email|default:'' }}" class="flex-1 border border-gray-300 dark:border-dark-border text-gray-700 dark:text-dark-text px-4 py-2 rounded-lg text-sm font-medium text-center hover:bg-gray-50 dark:hover:bg-dark-hover transition-colors">
              Contact
            </a>
          </div>
        </div>
      </div>

      <!-- Report Summary -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-text mb-4">Report Summary</h3>
          <div class="space-y-4">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Report ID</p>
              <p class="font-medium text-gray-900 dark:text-dark-text">{{ report.report_id }}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Generated</p>
              <p class="font-medium text-gray-900 dark:text-dark-text">{{ report.generated_at|date:"M j, Y H:i" }}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Confidence Level</p>
              <p class="font-medium text-gray-900 dark:text-dark-text">{{ report.confidence_level|title }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Assessment -->
      {% if report.risk_factors %}
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-text mb-4">Risk Assessment</h3>
          <div class="space-y-2">
            {% for risk in report.risk_factors %}
              <div class="flex items-start">
                <div class="w-2 h-2 bg-red-500 rounded-full mr-3 mt-2"></div>
                <span class="text-sm text-gray-700 dark:text-gray-300">{{ risk }}</span>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Data Quality -->
      <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
        <div class="p-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-text mb-4">Data Quality</h3>
          <div class="space-y-3">
            {% for category, score in report.data_quality_assessment.items %}
              {% if category != 'overall' %}
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-gray-500 dark:text-gray-400">{{ category }}</span>
                  <span class="text-sm font-medium text-gray-900 dark:text-dark-text">{{ score|floatformat:1 }}</span>
                </div>
                <div class="w-full h-1 bg-gray-200 dark:bg-dark-border rounded-full overflow-hidden">
                  <div class="h-1
                    {% if score > 0.8 %}bg-green-500
                    {% elif score > 0.6 %}bg-yellow-500
                    {% else %}bg-red-500{% endif %}"
                    style="width: {{ score|floatformat:0 }}%"></div>
                </div>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endwith %}
  {% else %}
    <!-- Loading/Processing State -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 mt-6">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 animate-spin text-brand-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <div>
          <p class="font-medium text-gray-900 dark:text-white">Analyzing candidate profile...</p>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">This usually takes 2-3 minutes</p>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Alpine.js for interactive features -->
<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('jobFitReport', () => ({
    showDetails: {},

    toggleDetails(section) {
      this.showDetails[section] = !this.showDetails[section];
    },

    isDetailsVisible(section) {
      return this.showDetails[section] || false;
    }
  }));
});
</script>
{% endblock %}