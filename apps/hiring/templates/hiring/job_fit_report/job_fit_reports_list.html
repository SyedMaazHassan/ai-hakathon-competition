{% extends "core/new_base.html" %}
{% load static %}

{% block title %}Job Fit Reports | Frontline Assistant AI{% endblock %}
{% block current_page %}Reports{% endblock %}
{% block page_title %}Job Fit Reports{% endblock %}
{% block page_subtitle %}AI-powered analysis of candidate job fit scores{% endblock %}

{% block extra_head %}
<style>
.filter-active {
    background-color: #f97316;
    color: white;
    border-color: #f97316;
}

.hidden-card {
    display: none;
}

/* Fix dropdown z-index issues */
.dropdown-menu {
    z-index: 10 !important;
}

/* Ensure proper positioning for dropdowns */
.relative {
    position: relative;
}

/* Fix any cursor issues with dropdowns */
.dropdown-button {
    cursor: pointer;
}

.dropdown-button:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="jobFitReportsApp()" x-init="init()">
  <!-- Enhanced Header with Search and Filters -->
  <div class="space-y-4 mb-6">
    <!-- Top Row: Title and Actions -->
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-dark-text">Job Fit Reports</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          AI-powered analysis of candidate job fit scores
        </p>
      </div>
      <div class="flex gap-2">
        <button class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-dark-border rounded-md text-sm font-medium text-gray-700 dark:text-dark-text bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-dark-hover">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" x2="12" y1="15" y2="3"/>
          </svg>
          Export Reports
        </button>
      </div>
    </div>


    <!-- Search and Filters Row -->
    <div class="flex flex-col lg:flex-row gap-4">
      <div class="relative flex-1 max-w-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-500 dark:text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.3-4.3"/>
        </svg>
        <input
          type="text"
          x-model="searchTerm"
          placeholder="Search by job title, candidate name, skills, or strengths..."
          class="w-full h-9 pl-10 pr-3 rounded-md border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-card text-gray-900 dark:text-dark-text text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
        />
      </div>

      <div class="flex gap-2">
        <!-- Status Filter -->
        <div class="relative" x-data="{ open: false }">
          <button
            @click="open = !open"
            class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-dark-border rounded-md text-sm font-medium text-gray-700 dark:text-dark-text bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-dark-hover"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
            <span x-text="statusFilter === 'all' ? 'All Status' : statusFilter"></span>
          </button>
          <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-md shadow-lg z-10">
            <div class="py-1">
              <button @click="statusFilter = 'all'; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">All Status</button>
              <button @click="statusFilter = 'completed'; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Completed</button>
              <button @click="statusFilter = 'processing'; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Processing</button>
              <button @click="statusFilter = 'failed'; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Failed</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="flex items-center justify-between text-sm">
      <span class="text-gray-600 dark:text-gray-400">
        Showing <span x-text="startIndex + 1"></span>-<span x-text="Math.min(startIndex + itemsPerPage, filteredReports.length)"></span> of <span x-text="filteredReports.length"></span> reports
      </span>
      <div class="flex items-center gap-2">
        <span class="text-gray-600 dark:text-gray-400">Show:</span>
        <div class="relative" x-data="{ open: false }">
          <button @click="open = !open" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-dark-border rounded-md text-sm font-medium text-gray-700 dark:text-dark-text bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-dark-hover">
            <span x-text="itemsPerPage"></span>
          </button>
          <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 mt-2 w-20 bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-md shadow-lg z-10">
            <div class="py-1">
              <button @click="itemsPerPage = 10; currentPage = 1; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">10</button>
              <button @click="itemsPerPage = 25; currentPage = 1; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">25</button>
              <button @click="itemsPerPage = 50; currentPage = 1; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">50</button>
              <button @click="itemsPerPage = 100; currentPage = 1; open = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">100</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Table -->
  <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-lg shadow-sm">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-200 dark:border-dark-border bg-gray-50 dark:bg-dark-hover">
            <th class="w-[300px] px-6 py-3 text-left">
              <button
                @click="handleSort('candidate_name')"
                class="flex items-center gap-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-dark-text"
              >
                Candidate & Job
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 6h18"/>
                  <path d="M7 12h10"/>
                  <path d="M10 18h4"/>
                </svg>
              </button>
            </th>
            <th class="px-6 py-3 text-left">
              <button
                @click="handleSort('status')"
                class="flex items-center gap-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-dark-text"
              >
                Status
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 6h18"/>
                  <path d="M7 12h10"/>
                  <path d="M10 18h4"/>
                </svg>
              </button>
            </th>
            <th class="px-6 py-3 text-left">
              <button
                @click="handleSort('fit_score')"
                class="flex items-center gap-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-dark-text"
              >
                Fit Score
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 6h18"/>
                  <path d="M7 12h10"/>
                  <path d="M10 18h4"/>
                </svg>
              </button>
            </th>
            <th class="px-6 py-3 text-left">
              <button
                @click="handleSort('created_at')"
                class="flex items-center gap-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-dark-text"
              >
                Created
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 6h18"/>
                  <path d="M7 12h10"/>
                  <path d="M10 18h4"/>
                </svg>
              </button>
            </th>
            <th class="px-6 py-3 text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Alpine.js version -->
          <template x-for="report in paginatedReports" :key="report.id">
            <tr class="border-b border-gray-200 dark:border-dark-border hover:bg-gray-50 dark:hover:bg-dark-hover cursor-pointer transition-colors duration-150" @click="viewReport(report.id)">
              <td class="px-6 py-4">
                <div class="space-y-2">
                  <div class="font-medium text-gray-900 dark:text-dark-text hover:text-orange-600 dark:hover:text-orange-400 transition-colors" x-text="report.candidate_name || 'Unknown Candidate'"></div>
                  <div class="text-sm text-gray-500 dark:text-gray-400" x-text="'Applied for: ' + (report.job_title || 'Job')"></div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                  <template x-if="report.status === 'completed'">
                    <div class="flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.801 10A10 10 0 1 1 17 3.335"/>
                        <path d="m9 11 3 3L22 4"/>
                      </svg>
                      <span class="px-2 py-1 text-xs font-semibold rounded border border-green-300 text-green-700 bg-green-100 dark:bg-green-900 dark:text-green-300 dark:border-green-700">Completed</span>
                    </div>
                  </template>
                  <template x-if="report.status === 'failed'">
                    <div class="flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="m15 9-6 6"/>
                        <path d="m9 9 6 6"/>
                      </svg>
                      <span class="px-2 py-1 text-xs font-semibold rounded border border-red-300 text-red-700 bg-red-100 dark:bg-red-900 dark:text-red-300 dark:border-red-700">Failed</span>
                    </div>
                  </template>
                  <template x-if="report.status === 'processing'">
                    <div class="flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-orange-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                      </svg>
                      <span class="px-2 py-1 text-xs font-semibold rounded border border-orange-300 text-orange-700 bg-orange-100 dark:bg-orange-900 dark:text-orange-300 dark:border-orange-700">Processing</span>
                    </div>
                  </template>
                </div>
              </td>
              <td class="px-6 py-4">
                <template x-if="report.status === 'completed'">
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-orange-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/>
                      <polyline points="16 7 22 7 22 13"/>
                    </svg>
                    <span class="text-lg font-semibold text-orange-600" x-text="report.fit_score + '%'"></span>
                  </div>
                </template>
                <template x-if="report.status === 'processing'">
                  <div class="flex items-center gap-2 text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span class="text-sm">Analyzing...</span>
                  </div>
                </template>
                <template x-if="report.status === 'failed'">
                  <span class="text-sm text-red-600 dark:text-red-400">Analysis failed</span>
                </template>
              </td>
              <td class="px-6 py-4">
                  <div class="text-sm text-gray-500 dark:text-gray-400" x-text="formatDate(report.created_at)"></div>
              </td>
              <td class="px-6 py-4 text-right">
                <div class="dropdown-container" x-data="{ open: false }" @click.outside="open = false">
                  <button
                    @click.stop="open = !open"
                    class="dropdown-trigger"
                    :class="{ 'bg-gray-100 dark:bg-dark-hover': open }"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="1"/>
                      <circle cx="19" cy="12" r="1"/>
                      <circle cx="5" cy="12" r="1"/>
                    </svg>
                  </button>
                  <div x-show="open" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="dropdown-menu">
                    <button @click="viewReport(report.id); open = false" class="dropdown-item">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                      View Report
                    </button>
                    <button @click="viewCandidate(report.candidate_id); open = false" class="dropdown-item">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                      </svg>
                      View Candidate
                    </button>
                    <button @click="viewJob(report.job_id); open = false" class="dropdown-item">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/>
                      </svg>
                      View Job
                    </button>
                    <template x-if="report.status !== 'completed'">
                      <button @click="retryAnalysis(report.id); open = false" class="dropdown-item" style="color: #ea580c;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21.801 10A10 10 0 1 1 17 3.335"/>
                          <path d="m9 11 3 3L22 4"/>
                        </svg>
                        Retry Analysis
                      </button>
                    </template>
                    <button @click="deleteReport(report.id); open = false" class="dropdown-item danger">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                      </svg>
                      Delete Report
                    </button>
                  </div>
                </div>
              </td>
            </tr>
          </template>

          <!-- Empty State -->
          <tr x-show="paginatedReports.length === 0">
            <td colspan="5" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
              <div x-show="filteredReports.length === 0">
                <div class="text-gray-500 dark:text-gray-400 mb-2">No reports found matching your criteria.</div>
                <button
                  x-show="searchTerm"
                  @click="searchTerm = ''"
                  class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                >
                  Clear search
                </button>
              </div>
              <div x-show="filteredReports.length > 0">No reports on this page.</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Enhanced Pagination -->
  <div x-show="totalPages > 1" class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-dark-border">
    <div class="text-sm text-gray-500 dark:text-gray-400">
      Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
    </div>
    <div class="flex items-center gap-2">
      <button
        @click="handlePageChange(currentPage - 1)"
        :disabled="currentPage === 1"
        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-dark-border rounded-md text-sm font-medium text-gray-700 dark:text-dark-text bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-dark-hover disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        Previous
      </button>

      <!-- Page numbers -->
      <div class="flex gap-1">
        <template x-for="pageNum in getPageNumbers()" :key="pageNum">
          <button
            @click="handlePageChange(pageNum)"
            class="w-8 h-8 p-0 text-sm font-medium rounded"
          :class="currentPage === pageNum ? 'bg-orange-600 text-white' : 'border border-gray-300 dark:border-dark-border text-gray-700 dark:text-dark-text bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-dark-hover'"
            x-text="pageNum"
          ></button>
        </template>
      </div>

      <button
        @click="handlePageChange(currentPage + 1)"
        :disabled="currentPage === totalPages"
        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-dark-border rounded-md text-sm font-medium text-gray-700 dark:text-dark-text bg-white dark:bg-dark-card hover:bg-gray-50 dark:hover:bg-dark-hover disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Next
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m9 18 6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // Pass reports data from Django to JavaScript
  window.reportsData = [
    {% for app in applications %}
    {
      id: {{ app.id }},
      candidate_name: "{{ app.resume.metadata.name|default:app.resume.file.name|escapejs }}",
      job_title: "{{ app.job.parsed_detailed.title|default:""|escapejs }}",
      status: "{% if app.job_fit_report %}completed{% elif app.status|lower == 'failed' %}failed{% else %}processing{% endif %}",
      fit_score: {{ app.job_fit_report.scoring.overall_fit_score|default:0 }},
      created_at: "{{ app.applied_at|date:"c" }}",
      candidate_id: {{ app.resume.id }},
      job_id: {{ app.job.id }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
</script>
<script src="{% static 'js/job_fit_reports_list.js' %}"></script>
{% endblock %}