{% extends "core/new_base.html" %}

{% block title %}Bulk Upload Resumes | Frontline Assistant AI{% endblock %}
{% block current_page %}Bulk Upload{% endblock %}
{% block page_title %}Create Job & Match Candidates{% endblock %}
{% block page_subtitle %}Follow the steps to create a job posting and find the best candidates{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <!-- Step wizard header -->
  <div class="mt-6 flex justify-center">
    <div class="flex items-center">
      <!-- Step 1: done -->
      <div class="flex items-center">
        <div class="flex flex-col items-center">
          <div class="w-10 h-10 rounded-full border-2 border-orange-500 bg-orange-500 text-white flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
          </div>
          <div class="text-center mt-2">
            <p class="text-orange-500 font-medium text-sm">Job Details</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs max-w-24 mt-1">Basic job information</p>
          </div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500 dark:text-gray-400 -mt-8 mx-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </div>

      <!-- Step 2: active -->
      <div class="flex items-center">
        <div class="flex flex-col items-center">
          <div class="w-10 h-10 rounded-full border-2 border-orange-500 bg-gray-50 dark:bg-gray-800 text-orange-500 flex items-center justify-center">
            <span class="font-medium text-sm">2</span>
          </div>
          <div class="text-center mt-2">
            <p class="text-orange-500 font-medium text-sm">Upload Resumes</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs max-w-24 mt-1">Add candidate resumes</p>
          </div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500 dark:text-gray-400 -mt-8 mx-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </div>

      <!-- Step 3: upcoming -->
      <div class="flex items-center">
        <div class="flex flex-col items-center">
          <div class="w-10 h-10 rounded-full border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400 flex items-center justify-center">
            <span class="font-medium text-sm">3</span>
          </div>
          <div class="text-center mt-2">
            <p class="text-gray-500 dark:text-gray-400 font-medium text-sm">Match Candidates</p>
            <p class="text-gray-500 dark:text-gray-400 text-xs max-w-24 mt-1">Generate job fit reports</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" id="uploadForm" class="mt-6">
    {% csrf_token %}

    <div class="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-xl">
      <div class="p-6">
        <div>
          <h2 class="text-xl font-semibold mb-2">Upload Resumes</h2>
          <p class="text-gray-600">Upload candidate resumes that you want to analyze for this job</p>
        </div>

        <div class="mt-6">
          <div id="dropZone" class="border-2 border-dashed border-gray-300 dark:border-dark-border rounded-xl p-8 text-center cursor-pointer hover:border-orange-500 transition-colors">
            <input type="file" name="files" id="id_files" multiple accept=".pdf,.doc,.docx" class="hidden" />
            <div class="flex flex-col items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-gray-500 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
              <h3 class="text-lg font-medium mb-2">Upload Resume Files</h3>
              <p class="text-gray-600 text-sm mb-4">Drag and drop your resume files here, or click to browse</p>
              <p class="text-gray-500 text-sm mb-4">Supports: PDF, DOC, DOCX • Max size: 10MB • Multiple files allowed</p>
              <label for="id_files">
                <span class="inline-flex items-center h-9 px-4 rounded-md border border-gray-300 text-sm font-medium">Browse Files</span>
              </label>
            </div>
          </div>
        </div>

        <div id="fileList" class="space-y-2 hidden mt-6">
          <h4 class="text-sm font-medium text-gray-700 dark:text-dark-text">Selected files:</h4>
          <ul id="selectedFiles" class="space-y-2"></ul>
        </div>

        <!-- Upload Guidelines card -->
        <div class="mt-6 bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-xl">
          <div class="p-6">
            <h3 class="text-lg font-semibold">Upload Guidelines</h3>
            <div class="mt-3 space-y-2 text-sm text-gray-700 dark:text-gray-200">
              <p><span class="font-medium">Supported formats:</span> PDF, DOC, DOCX</p>
              <p><span class="font-medium">Maximum file size:</span> 10 MB per file</p>
              <p><span class="font-medium">Multiple uploads:</span> You can upload multiple resumes at once</p>
              <p><span class="font-medium">Processing:</span> Files are automatically processed and analyzed</p>
              <p class="text-gray-600 dark:text-gray-300"><span class="font-medium">Tip:</span> For best results, upload clear, well-formatted resumes. Our AI will automatically extract candidate information, skills, and experience.</p>
            </div>
          </div>
        </div>

        {% if form.non_field_errors %}
          <div class="text-red-500 text-sm mt-4">
            {% for error in form.non_field_errors %}
              <p>{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="px-6 py-4 border-t border-gray-200 dark:border-dark-border bg-gray-50 dark:bg-dark-hover flex items-center justify-between">
        <a href="{% url 'jobs:job_create' %}" class="h-9 px-4 rounded-md border border-gray-300 dark:border-dark-border text-sm font-medium dark:text-dark-text">Previous</a>
        <button type="submit" id="uploadButton" class="h-9 px-4 rounded-md bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Next Step
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </button>
      </div>
    </div>
  </form>
</div>

<style>
  .file-item {
    display: flex;
    align-items: center;
    justify-content: between;
    padding: 0.5rem;
    background-color: rgba(243, 244, 246, 0.5);
    border-radius: 0.375rem;
  }
  .dark .file-item {
    background-color: rgba(55, 65, 81, 0.5);
  }
  .remove-file {
    color: #ef4444;
    cursor: pointer;
    margin-left: auto;
    padding: 0.25rem;
  }
  .remove-file:hover {
    color: #dc2626;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_files');
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const selectedFiles = document.getElementById('selectedFiles');
    const uploadButton = document.getElementById('uploadButton');
    const form = document.getElementById('uploadForm');

    let files = [];

    // Handle click on drop zone
    dropZone.addEventListener('click', (e) => {
      if (e.target !== dropZone && !e.target.classList.contains('remove-file')) {
        fileInput.click();
      }
    });

    // Handle file selection
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // Drag and drop handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      dropZone.classList.add('border-blue-400');
      dropZone.classList.remove('border-gray-300', 'dark:border-gray-600');
    }

    function unhighlight() {
      dropZone.classList.remove('border-blue-400');
      dropZone.classList.add('border-gray-300', 'dark:border-gray-600');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const droppedFiles = dt.files;
      handleFiles(droppedFiles);
    }

    // Process selected files
    function handleFiles(newFiles) {
      // Convert FileList to array and filter by accepted types
      const validFiles = Array.from(newFiles).filter(file => {
        const extension = file.name.split('.').pop().toLowerCase();
        return ['pdf', 'doc', 'docx'].includes(extension);
      });

      // Add to our files array (but limit to 10 total)
      const remainingSlots = 10 - files.length;
      if (remainingSlots > 0) {
        files = [...files, ...validFiles.slice(0, remainingSlots)];
        updateFileList();
      } else {
        alert('Maximum of 10 files allowed');
      }

      // Clear the input to allow selecting the same file again if needed
      fileInput.value = '';
    }

    // Update the file list UI
    function updateFileList() {
      // Clear the current list
      selectedFiles.innerHTML = '';

      if (files.length > 0) {
        fileList.classList.remove('hidden');
        uploadButton.disabled = false;

        // Add each file to the list
        files.forEach((file, index) => {
          const li = document.createElement('li');
          li.className = 'file-item';

          const fileInfo = document.createElement('div');
          fileInfo.className = 'flex-1 truncate';

          const fileName = document.createElement('p');
          fileName.className = 'text-sm font-medium text-gray-700 dark:text-gray-300 truncate';
          fileName.textContent = file.name;

          const fileSize = document.createElement('p');
          fileSize.className = 'text-xs text-gray-500 dark:text-gray-400';
          fileSize.textContent = formatFileSize(file.size);

          fileInfo.appendChild(fileName);
          fileInfo.appendChild(fileSize);

          const removeBtn = document.createElement('span');
          removeBtn.className = 'remove-file';
          removeBtn.innerHTML = '&times;';
          removeBtn.addEventListener('click', () => removeFile(index));

          li.appendChild(fileInfo);
          li.appendChild(removeBtn);
          selectedFiles.appendChild(li);
        });
      } else {
        fileList.classList.add('hidden');
        uploadButton.disabled = true;
      }
    }

    // Format file size to human readable format
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';

      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));

      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Remove a file from the list
    function removeFile(index) {
      files.splice(index, 1);
      updateFileList();
    }

    // Handle form submission
    form.addEventListener('submit', function(e) {
      if (files.length === 0) {
        e.preventDefault();
        return;
      }

      // Create a new FormData and append all files
      const formData = new FormData(form);

      // Remove any existing files from the form data
      formData.delete('files');

      // Append our files
      files.forEach(file => {
        formData.append('files', file);
      });

      // Replace the form submission with our custom one
      e.preventDefault();

      // You might want to show a loading indicator here

      // Submit the form with our files
      fetch(form.action, {
        method: form.method,
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          return response.json();
        }
      })
      .then(data => {
        if (data && data.errors) {
          // Handle errors if needed
          console.error(data.errors);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
  });
</script>
{% endblock %}